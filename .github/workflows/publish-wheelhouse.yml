name: Publish Wheelhouse

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual triggering

jobs:
  publish-wheelhouse:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      - name: Download wheels from all releases
        run: |
          mkdir -p all-wheels
          
          # Get list of all releases
          echo "Fetching all releases..."
          gh release list --limit 100 --json tagName > releases.json
          
          # Download wheels from each release
          for release in $(jq -r '.[].tagName' releases.json); do
            echo "Processing release: $release"
            
            # Download all .whl assets from this release
            gh release download "$release" --pattern "*.whl" --dir "all-wheels/" --skip-existing || true
          done
          
          echo "Downloaded wheels:"
          ls -la all-wheels/ || echo "No wheels found"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Install wheel indexing tools
        run: |
          pip install dumb-pypi

      - name: Organize wheels by backend
        run: |
          mkdir -p dist/{cpu,cu126,cu128,cu129}
          
          # Check if any wheels exist
          if ! ls all-wheels/*.whl 1> /dev/null 2>&1; then
            echo "No wheel files found in all-wheels/"
            exit 1
          fi
          
          # Sort wheels by CUDA version in filename
          for wheel in all-wheels/*.whl; do
            if [[ "$wheel" == *"+cpu"* ]] || [[ "$wheel" != *"+cu"* ]]; then
              cp "$wheel" dist/cpu/
            elif [[ "$wheel" == *"+cu126"* ]]; then
              cp "$wheel" dist/cu126/
            elif [[ "$wheel" == *"+cu128"* ]]; then
              cp "$wheel" dist/cu128/
            elif [[ "$wheel" == *"+cu129"* ]]; then
              cp "$wheel" dist/cu129/
            else
              # Default to CPU if unclear
              cp "$wheel" dist/cpu/
            fi
          done

      - name: Generate PyPI-compatible indices
        run: |
          mkdir -p pages
          
          for backend in cpu cu126 cu128 cu129; do
            if [ -n "$(ls dist/$backend/*.whl 2>/dev/null)" ]; then
              echo "Creating index for $backend"
              
              # Create package list for dumb-pypi
              ls dist/$backend/*.whl | xargs -n1 basename > dist/$backend/package-list.txt
              
              # Copy wheels to packages subdirectory
              mkdir -p pages/$backend/packages
              cp dist/$backend/*.whl pages/$backend/packages/
              
              # Generate index with dumb-pypi, pointing to packages subdirectory
              dumb-pypi \
                --package-list dist/$backend/package-list.txt \
                --packages-url "../../packages/" \
                --output-dir pages/$backend
              
              # Count wheels and versions for this backend
              wheel_count=$(ls dist/$backend/*.whl 2>/dev/null | wc -l || echo "0")
              versions=$(ls dist/$backend/*.whl 2>/dev/null | sed 's/.*-\([0-9][^-]*\)-.*/\1/' | sort -V | uniq | tr '\n' ', ' | sed 's/,$//' || echo "none")
              
              # Create a simple index.html for the backend
              cat > pages/$backend/index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <title>torch-projectors wheels ($backend)</title>
          </head>
          <body>
              <h1>torch-projectors wheels ($backend)</h1>
              <p><strong>$wheel_count wheels available</strong></p>
              <p><strong>Versions:</strong> $versions</p>
              <p>Install with: <code>pip install torch-projectors --index-url https://warpem.github.io/torch-projectors/$backend/simple/</code></p>
              <p><a href="simple/">Package Index</a></p>
          </body>
          </html>
          EOF
            fi
          done

          # Create main index page
          cat > pages/index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <title>torch-projectors wheelhouse</title>
          </head>
          <body>
              <h1>torch-projectors wheelhouse</h1>
              <p>Select your PyTorch CUDA version:</p>
              <ul>
                  <li><a href="cpu/">CPU only</a> - <code>pip install torch-projectors --index-url https://warpem.github.io/torch-projectors/cpu/simple/</code></li>
                  <li><a href="cu126/">CUDA 12.6</a> - <code>pip install torch-projectors --index-url https://warpem.github.io/torch-projectors/cu126/simple/</code></li>
                  <li><a href="cu128/">CUDA 12.8</a> - <code>pip install torch-projectors --index-url https://warpem.github.io/torch-projectors/cu128/simple/</code></li>
                  <li><a href="cu129/">CUDA 12.9</a> - <code>pip install torch-projectors --index-url https://warpem.github.io/torch-projectors/cu129/simple/</code></li>
              </ul>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4