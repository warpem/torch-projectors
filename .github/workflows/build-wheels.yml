name: Build Wheels

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v0.1.0, v1.2.3
  workflow_dispatch:  # Allow manual triggering

jobs:
  # TODO: Re-enable after debugging build process
  # # Test before building wheels
  # test:
  #   name: Test on ${{ matrix.os }} - ${{ matrix.backend }}
  #   runs-on: ${{ matrix.os }}
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       include:
  #         # Linux - CPU (initial testing)
  #         - os: linux-cpu-x64
  #           backend: cpu
  #           torch-index: https://download.pytorch.org/whl/cpu
  #         
  #         # TODO: Uncomment for full testing
  #         # # macOS - CPU + MPS (requires Sequoia for build)
  #         # - os: macos-15  # Sequoia for atomics build support
  #         #   backend: cpu-mps
  #         #   torch-index: https://download.pytorch.org/whl/cpu
  #         # # Linux - CUDA (Tesla T4 for testing)
  #         # - os: gpu-t4-4-core-linux
  #         #   backend: cuda
  #         #   torch-index: https://download.pytorch.org/whl/cu121
  #         # # Windows - CPU
  #         # - os: windows-latest
  #         #   backend: cpu
  #         #   torch-index: https://download.pytorch.org/whl/cpu

  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         submodules: recursive

  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.11'

  #     - name: Install PyTorch (matching CUDA version)
  #       run: |
  #         python -m pip install --upgrade pip
  #         # Install PyTorch matching the target CUDA version
  #         if [[ "${{ matrix.backend }}" == "cpu"* ]]; then
  #           pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
  #         elif [[ "${{ matrix.backend }}" == "cuda" ]]; then
  #           pip install torch torchvision --index-url https://download.pytorch.org/whl/cu121
  #         else
  #           pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
  #         fi

  #     - name: Install build requirements  
  #       run: |
  #         pip install pytest matplotlib pybind11 setuptools wheel numpy

  #     - name: Build extension
  #       run: |
  #         python -m pip install -e .
  #       env:
  #         TORCH_PROJECTORS_BUILD_BACKEND: ${{ matrix.backend }}

  #     - name: Run tests (excluding performance tests)
  #       run: |
  #         pytest tests/ -v --ignore-glob="*performance*"
  #       continue-on-error: ${{ matrix.backend == 'cuda' }}  # Don't fail build if CUDA tests fail

  # Build wheels after tests pass
  build-wheels:
    name: Build wheels on ${{ matrix.os }}
    # needs: test  # TODO: Re-enable after debugging build process
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux CUDA builds (separate jobs for each CUDA version)
          - os: linux-cpu-x64-1
            cibw-arch: "x86_64"
            backend: "cuda126"
            torch-version: "2.6.0"
            torch-index: "https://download.pytorch.org/whl/cu126"
            cuda-version: "12.6"
          # - os: linux-cpu-x64-2
          #   cibw-arch: "x86_64" 
          #   backend: "cuda128"
          #   torch-version: "2.7.0"
          #   torch-index: "https://download.pytorch.org/whl/cu128"
          #   cuda-version: "12.8"
          # - os: linux-cpu-x64-3
          #   cibw-arch: "x86_64"
          #   backend: "cuda129" 
          #   torch-version: "2.8.0"
          #   torch-index: "https://download.pytorch.org/whl/cu129"
          #   cuda-version: "12.9"
          
          # # Linux CPU build
          # - os: linux-cpu-x64-4
          #   cibw-arch: "x86_64"
          #   backend: "cpu"
          #   torch-version: "2.6.0"
          #   torch-index: "https://download.pytorch.org/whl/cpu"
          
          # TODO: Re-enable after Linux builds are working
          # # macOS Apple Silicon - Sequoia for atomics, ARM64 native
          # - os: macos-15-xlarge
          #   cibw-arch: "arm64"
          #   backend: "cpu-mps"
          #   torch-version: "2.6.0"
          # 
          # # Windows CPU build
          # - os: windows-x64-cpu
          #   cibw-arch: "AMD64"
          #   backend: "cpu"
          #   torch-version: "2.6.0"

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Extract version from tag (Unix)
        if: runner.os != 'Windows'
        id: version_unix
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            BUILD_NUMBER=${GITHUB_RUN_NUMBER}
          else
            VERSION="0.0.0+dev${GITHUB_RUN_NUMBER}"
            BUILD_NUMBER=${GITHUB_RUN_NUMBER}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          # Set backend suffix based on matrix backend
          case "${{ matrix.backend }}" in
            cuda126) echo "backend_suffix=+cu126" >> $GITHUB_OUTPUT ;;
            cuda128) echo "backend_suffix=+cu128" >> $GITHUB_OUTPUT ;;
            cuda129) echo "backend_suffix=+cu129" >> $GITHUB_OUTPUT ;;
            cpu-mps) echo "backend_suffix=+cpu" >> $GITHUB_OUTPUT ;;
            *) echo "backend_suffix=+cpu" >> $GITHUB_OUTPUT ;;
          esac

      - name: Extract version from tag (Windows)
        if: runner.os == 'Windows'
        id: version_windows
        run: |
          if ("${{ github.ref }}" -like "refs/tags/v*") {
            $VERSION = "${{ github.ref }}".Replace("refs/tags/v", "")
            $BUILD_NUMBER = $env:GITHUB_RUN_NUMBER
          } else {
            $VERSION = "0.0.0+dev$env:GITHUB_RUN_NUMBER"
            $BUILD_NUMBER = $env:GITHUB_RUN_NUMBER
          }
          echo "version=$VERSION" >> $env:GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $env:GITHUB_OUTPUT
          # Set backend suffix based on matrix backend
          switch ("${{ matrix.backend }}") {
            "cuda126" { echo "backend_suffix=+cu126" >> $env:GITHUB_OUTPUT }
            "cuda128" { echo "backend_suffix=+cu128" >> $env:GITHUB_OUTPUT }
            "cuda129" { echo "backend_suffix=+cu129" >> $env:GITHUB_OUTPUT }
            "cpu-mps" { echo "backend_suffix=+cpu" >> $env:GITHUB_OUTPUT }
            default { echo "backend_suffix=+cpu" >> $env:GITHUB_OUTPUT }
          }
        shell: pwsh

      - name: Set version outputs
        id: version
        run: |
          echo "version=${{ steps.version_unix.outputs.version || steps.version_windows.outputs.version }}" >> $GITHUB_OUTPUT
          echo "build_number=${{ steps.version_unix.outputs.build_number || steps.version_windows.outputs.build_number }}" >> $GITHUB_OUTPUT
          echo "backend_suffix=${{ steps.version_unix.outputs.backend_suffix || steps.version_windows.outputs.backend_suffix }}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.23
        env:
          # Build matrix for different backends (using standard pip instead of uv)
          CIBW_ARCHS: ${{ matrix.cibw-arch }}
          # Version management following PyTorch pattern
          TORCH_PROJECTORS_BUILD_VERSION: ${{ steps.version.outputs.version }}
          TORCH_PROJECTORS_BUILD_NUMBER: ${{ steps.version.outputs.build_number }}
          # Pass matrix variables to cibuildwheel
          TORCH_PROJECTORS_BUILD_BACKEND: ${{ matrix.backend }}
          TORCH_PROJECTORS_TORCH_VERSION: ${{ matrix.torch-version }}
          TORCH_PROJECTORS_TORCH_INDEX: ${{ matrix.torch-index }}
          TORCH_PROJECTORS_CUDA_VERSION: ${{ matrix.cuda-version || '' }}

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.cibw-arch }}-${{ matrix.backend }}
          path: ./wheelhouse/*.whl

  # Create release and upload wheels
  release:
    name: Create Release
    needs: build-wheels
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.whl
          generate_release_notes: true